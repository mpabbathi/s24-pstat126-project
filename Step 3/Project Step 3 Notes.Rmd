---
title: "Project Step 3"
author: "Minu Pabbathi, Ziqian Zhao, Paul Zhang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(GGally)
library(modelr)
library(tidyverse)
library(broom)
heart_disease_data <- read.csv("~/Documents/GitHub/s24-pstat126-project/dataset/heart_disease_data_1.csv")

set.seed(7)
train_idx <- sample(1:nrow(heart_disease_data), 0.7 * nrow(heart_disease_data)) 
train_data <- heart_disease_data[train_idx, ] 
test_data <- heart_disease_data[-train_idx, ] 
```

# Introduction

This data set dates from 1988 and consists of four databases: Cleveland, Hungary, Switzerland, and Long Beach V. It contains information about patients and risk factors for heart disease as well as whether or not they eventually end up developing heart disease. For the sake of convenience, we have randomly chosen 500 observations from the original data set. Here, we are going to investigate the relationship between the variable "age" and "maximum heart rate".

# Selecting Model

Used a forward stepwise model, meaning we assumed no relationship between the variables, and then added predictors one by one until no other significant predictors were left.

Criteria:

- AIC

```{r}
model_null = lm(thalach ~ 1, data = train_data)
model_full = lm(thalach ~., data = train_data)
step(model_null, direction="forward", scope=list(upper=model_full, lower=model_null), test = "F")
```

# Fitting Model

$F$ tests, $R^2$

$\beta$ interpretation

```{r}
fit <- lm(thalach ~ target + age + slope + exang + cp + trestbps + restecg, data = train_data)
summary(fit)
y_pred <- predict(fit, newdata = test_data)
```

## Finding $R^2$ of Predicted Values

```{r}
SS.total      <- sum((test_data$thalach - mean(test_data$thalach))^2)
SS.residual   <- sum((test_data$thalach - y_pred)^2)
SS.regression <- sum((y_pred - mean(test_data$thalach))^2)
SS.total - (SS.regression+SS.residual)
SS.regression/SS.total
```

## Residuals of Predicted Data

```{r}
res <- test_data$thalach - y_pred
plot(res)
abline(0, 0, col = "red")
```


# Plotting Predictions

```{r}
plot(x = test_data$thalach, y = y_pred, xlab = "Observed Data", ylab = "Predicted Data")
abline(a = 0, b = 1, lwd = 2, col = "green")
```

# Checking Influential Points

```{r}
p_caseinf <- augment(fit, train_data) %>%
  pivot_longer(cols = c(.resid, .hat, .cooksd)) %>%
  ggplot(aes(x = .rownames, y = value)) +
  facet_wrap(~ name, scales = 'free_y', nrow = 3) + # looks better with vertical faceting
  geom_point() +
  geom_hline(aes(yintercept = 0)) + # add line at zero
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25)) + # rotates and aligns labels
  labs(x = '', y = '')
p_caseinf
```

Selecting largest of each value:

```{r}
unusual_obs <- augment(fit, train_data) %>% 
  pivot_longer(cols = c(.resid, .hat, .cooksd)) %>%
  group_by(name) %>%
  slice_max(order_by = abs(value), n = 1) %>%
  ungroup()

p_caseinf + geom_point(data = unusual_obs, color = 'red')
```

Fitting with and without influential points:

```{r}
unusual_idx <- augment(fit, train_data) %>%
  mutate(idx = row_number()) %>%
  slice_max(order_by = abs(.resid), n = 1) %>%
  pull(idx)

fit_dropped <- lm(thalach ~ target + age + slope + exang + cp + trestbps + restecg, data = train_data[-unusual_idx, ])
summary(fit_dropped)
```

Since `restecg` is no longer statistically significant, as an exercise, we refit the model without it.

```{r}
fit_dropped_2 <- lm(thalach ~ target + age + slope + exang + cp + trestbps, data = train_data[-unusual_idx, ])
summary(fit_dropped_2)
```

# Model Interpretation

[insert variable names here] might not have an impact on maximum heart rate.

# Confidence Intervals and Prediction Intervals

```{r}
pred_ci <- train_data %>%
  cbind(ci = predict(fit, 
                     newdata = train_data, 
                     interval = 'confidence', 
                     level = 0.95))
```


